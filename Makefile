CORE = rel/epoch/bin/epoch
VER := $(shell cat VERSION)

REBAR ?= ./rebar3

EUNIT_VM_ARGS = $(CURDIR)/config/eunit.vm.args
EUNIT_SYS_CONFIG = $(CURDIR)/config/eunit.sys.config
EUNIT_TEST_FLAGS ?=

CT_TEST_FLAGS ?=
ST_CT_FLAGS = --logdir system_test/logs
ST_CT_DIR = --dir system_test
ST_CT_LOCALDIR = --dir system_test/only_local

SWAGGER_CODEGEN_CLI_V = 2.3.1
SWAGGER_CODEGEN_CLI = swagger/swagger-codegen-cli-$(SWAGGER_CODEGEN_CLI_V).jar
SWAGGER_CODEGEN = java -jar $(SWAGGER_CODEGEN_CLI)
SWAGGER_ENDPOINTS_SPEC = apps/aeutils/src/endpoints.erl

all:	local-build

$(SWAGGER_ENDPOINTS_SPEC):
	$(REBAR) swagger_endpoints

null  :=
space := $(null) # space
comma := ,

comma-separate = $(subst ${space},${comma},$(strip $1))
space-separate = $(subst ${comma},${space},$(strip $1))

ifdef SUITE
CT_TEST_FLAGS += --suite=$(call comma-separate,$(foreach suite,$(call space-separate,${SUITE}),${suite}_SUITE))
unexport SUITE
endif

ifdef GROUP
CT_TEST_FLAGS += --group=$(GROUP)
unexport GROUP
endif

ifdef TEST
CT_TEST_FLAGS += --case=$(TEST)
EUNIT_TEST_FLAGS += --module=$(TEST)
unexport TEST
endif

ifdef VERBOSE
CT_TEST_FLAGS += --verbose
unexport VERBOSE
endif

ifdef REPEAT
CT_TEST_FLAGS += --repeat=$(REPEAT)
unexport REPEAT
endif

PYTHON_DIR = py
PYTHON_TESTS = $(PYTHON_DIR)/tests

export AEVM_EXTERNAL_TEST_DIR=aevm_external
export AEVM_EXTERNAL_TEST_VERSION=348b0633f4a6ee3c100368bf0f4fca71394b4d01

HTTP_APP = apps/aehttp
SWTEMP := $(shell mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir')

console:
	@$(REBAR) as local shell --config config/dev.config --sname epoch

local-build: KIND=local
local-build: internal-build

local-start: KIND=local
local-start: internal-start

local-stop: KIND=local
local-stop: internal-stop

local-attach: KIND=local
local-attach: internal-attach

prod-package: KIND=prod
prod-package: internal-package

prod-compile-deps: KIND=prod
prod-compile-deps: internal-compile-deps

prod-build: KIND=prod
prod-build: internal-build

prod-start: KIND=prod
prod-start: internal-start

prod-stop: KIND=prod
prod-stop: internal-stop

prod-attach: KIND=prod
prod-attach: internal-attach

prod-clean: KIND=prod
prod-clean: internal-clean

multi-start:
	@$(MAKE) dev1-start
	@$(MAKE) dev2-start
	@$(MAKE) dev3-start

multi-stop:
	@$(MAKE) dev1-stop
	@$(MAKE) dev2-stop
	@$(MAKE) dev3-stop

multi-clean:
	@$(MAKE) dev1-clean
	@$(MAKE) dev2-clean
	@$(MAKE) dev3-clean

multi-distclean:
	@$(MAKE) dev1-distclean
	@$(MAKE) dev2-distclean
	@$(MAKE) dev3-distclean

dev1-build: KIND=dev1
dev1-build: internal-build

dev1-start: KIND=dev1
dev1-start: internal-start

dev1-stop: KIND=dev1
dev1-stop: internal-stop

dev1-attach: KIND=dev1
dev1-attach: internal-attach

dev1-clean: KIND=dev1
dev1-clean: internal-clean

dev1-distclean: KIND=dev1
dev1-distclean: internal-distclean

dev2-start: KIND=dev2
dev2-start: internal-start

dev2-stop: KIND=dev2
dev2-stop: internal-stop

dev2-attach: KIND=dev2
dev2-attach: internal-attach

dev2-clean: KIND=dev2
dev2-clean: internal-clean

dev2-distclean: KIND=dev2
dev2-distclean: internal-distclean

dev3-start: KIND=dev3
dev3-start: internal-start

dev3-stop: KIND=dev3
dev3-stop: internal-stop

dev3-attach: KIND=dev3
dev3-attach: internal-attach

dev3-clean: KIND=dev3
dev3-clean: internal-clean

dev3-distclean: KIND=dev3
dev3-distclean: internal-distclean

dialyzer-install: $(SWAGGER_ENDPOINTS_SPEC)
	@$(REBAR) tree
	@$(REBAR) dialyzer -u true -s false

dialyzer: $(SWAGGER_ENDPOINTS_SPEC)
	@$(REBAR) dialyzer

ct: KIND=test
ct: internal-build
	@EPOCH_PROCESSES="$$(ps -fea | grep bin/epoch | grep -v grep)"; \
	if [ $$(printf "%b" "$${EPOCH_PROCESSES}" | wc -l) -gt 0 ] ; then \
		(printf "%b\n%b\n" "Failed testing: another Epoch node is already running" "$${EPOCH_PROCESSES}" >&2; exit 1);\
	else \
		$(REBAR) ct $(CT_TEST_FLAGS) --sys_config config/test.config; \
	fi

REVISION:
	@git rev-parse HEAD > $@

eunit: KIND=test
eunit: internal-build
	@ERL_FLAGS="-args_file $(EUNIT_VM_ARGS) -config $(EUNIT_SYS_CONFIG)" ./rebar3 do eunit $(EUNIT_TEST_FLAGS)

all-tests: eunit test

docker:
	@docker build . -t aeternity/epoch:local

ST_DOCKER_FILTER=--filter label=epoch_system_test=true

docker-clean:
	$(eval RUNNING=$(shell docker container ls $(ST_DOCKER_FILTER) --format '{{.ID}}'))
	@if [ -n "$(RUNNING)" ]; then \
		echo "Stopping containers..."; \
		docker container stop $(RUNNING); \
	fi
	@echo "Deleting containers..."
	@docker container prune -f $(ST_DOCKER_FILTER)
	@echo "Deleting images..."
	@docker image prune -a -f $(ST_DOCKER_FILTER)

smoke-test: docker smoke-test-run

smoke-test-run: KIND=system_test
smoke-test-run: internal-build
	@$(REBAR) as $(KIND) do ct $(ST_CT_DIR) $(ST_CT_FLAGS) --suite=aest_sync_SUITE,aest_commands_SUITE,aest_peers_SUITE

local-system-test: KIND=system_test
local-system-test: internal-build
	@$(REBAR) as $(KIND) do ct $(ST_CT_LOCALDIR) $(ST_CT_FLAGS) --dir system_test/only_local $(CT_TEST_FLAGS)

system-test: KIND=system_test
system-test: internal-build
	@$(REBAR) as $(KIND) do ct $(ST_CT_DIR) $(ST_CT_FLAGS) $(CT_TEST_FLAGS)

aevm-test: aevm-test-deps
	@$(REBAR) eunit --application=aevm

aevm-test-deps: $(AEVM_EXTERNAL_TEST_DIR)/ethereum_tests
aevm-test-deps:
	$(eval VER=$(shell git -C "$(AEVM_EXTERNAL_TEST_DIR)/ethereum_tests" log -1 --pretty=format:"%H"))
	@if [ "$(VER)" != "$(AEVM_EXTERNAL_TEST_VERSION)" ]; then \
		git -C $(AEVM_EXTERNAL_TEST_DIR)/ethereum_tests checkout $(AEVM_EXTERNAL_TEST_VERSION); \
	fi

$(AEVM_EXTERNAL_TEST_DIR)/ethereum_tests:
	@git clone https://github.com/ethereum/tests.git $(AEVM_EXTERNAL_TEST_DIR)/ethereum_tests


python-env:
	( cd $(PYTHON_DIR) && $(MAKE) env; )

python-uats: swagger
	( cd $(PYTHON_DIR) && $(MAKE) uats; )

python-single-uat: swagger
	( cd $(PYTHON_DIR) && TEST_NAME=$(TEST_NAME) $(MAKE) single-uat; )

python-release-test: swagger
	( cd $(PYTHON_DIR) && WORKDIR="$(WORKDIR)" TARBALL=$(TARBALL) VER=$(VER) $(MAKE) release-test; )

swagger: config/swagger.yaml $(SWAGGER_CODEGEN_CLI) $(SWAGGER_ENDPOINTS_SPEC)
	@$(SWAGGER_CODEGEN) generate -i $< -l erlang-server -o $(SWTEMP)
	@echo "Swagger tempdir: $(SWTEMP)"
	@( mkdir -p $(HTTP_APP)/priv && cp $(SWTEMP)/priv/swagger.json $(HTTP_APP)/priv/; )
	@( cd $(HTTP_APP) && $(MAKE) updateswagger; )
	@rm -fr $(SWTEMP)
	@$(SWAGGER_CODEGEN) generate -i $< -l python -o $(SWTEMP)
	@echo "Swagger python tempdir: $(SWTEMP)"
	@cp -r $(SWTEMP)/swagger_client $(PYTHON_TESTS)
	@rm -fr $(SWTEMP)

swagger-docs:
	(cd ./apps/aehttp && $(MAKE) swagger-docs);

swagger-version-check:
	@( cd $(PYTHON_DIR) && \
		VERSION="$(CURDIR)/VERSION" \
		SWAGGER_YAML=$(CURDIR)/config/swagger.yaml \
		SWAGGER_JSON=$(CURDIR)/apps/aehttp/priv/swagger.json \
		$(MAKE) swagger-version-check )

swagger-check: swagger-version-check
	./swagger/check \
		"$(CURDIR)/config/swagger.yaml" \
		"swagger" \
		"$(CURDIR)/apps/aehttp/priv/swagger.json" \
		"$(CURDIR)/py/tests/swagger_client"

$(SWAGGER_CODEGEN_CLI):
	curl -fsS --create-dirs -o $@ http://central.maven.org/maven2/io/swagger/swagger-codegen-cli/$(SWAGGER_CODEGEN_CLI_V)/swagger-codegen-cli-$(SWAGGER_CODEGEN_CLI_V).jar

rebar-lock-check:
	./scripts/rebar_lock_check \
		"$(CURDIR)/rebar3" \
		"$(CURDIR)"

kill:
	@echo "Kill all beam processes only from this directory tree"
	$(shell pkill -9 -f ".*/beam.*-boot `pwd`" || true)

killall:
	@echo "Kill all beam processes from this host"
	@pkill -9 beam || true

clean:
	@$(REBAR) clean
	@-rm REVISION
	@-rm $(SWAGGER_ENDPOINTS_SPEC)
	( cd apps/aesophia/test/contracts && $(MAKE) clean; )
	( cd $(HTTP_APP) && $(MAKE) clean; )
	@$(MAKE) multi-distclean
	@rm -rf _build/system_test+test _build/system_test _build/test _build/prod _build/local
	@rm -rf _build/default/plugins
	@rm -rf $$(ls -d _build/default/lib/* | grep -v '[^_]rocksdb') ## Dependency `rocksdb` takes long to build.

distclean: clean
	( cd apps/aecuckoo && $(MAKE) distclean; )
	( cd otp_patches && $(MAKE) distclean; )
	( cd $(HTTP_APP) && $(MAKE) distclean; )
	@rm -rf _build/

multi-build: dev1-build
	@$(MAKE) dev2-distclean
	@$(MAKE) dev3-distclean
	@for x in dev2 dev3; do \
		cp -R _build/dev1 _build/$$x; \
		cp config/$$x/sys.config _build/$$x/rel/epoch/releases/$(VER)/sys.config; \
		cp config/$$x/vm.args _build/$$x/rel/epoch/releases/$(VER)/vm.args; \
	done

#
# Build rules
#

.SECONDEXPANSION:

internal-compile-deps: $$(KIND)
	@$(REBAR) as $(KIND) compile --deps-only

internal-package: $$(KIND)
internal-package: REVISION internal-compile-deps $(SWAGGER_ENDPOINTS_SPEC)
	@$(REBAR) as $(KIND) tar

internal-build: $$(KIND)
internal-build: REVISION internal-compile-deps $(SWAGGER_ENDPOINTS_SPEC)
	@$(REBAR) as $(KIND) release

internal-start: $$(KIND)
	@./_build/$(KIND)/$(CORE) start

internal-stop: $$(KIND)
	@./_build/$(KIND)/$(CORE) stop

internal-attach: $$(KIND)
	@./_build/$(KIND)/$(CORE) attach

internal-clean: $$(KIND)
	@rm -rf ./_build/$(KIND)/rel/epoch/data/mnesia
	@rm -rf ./_build/$(KIND)/rel/*/log/*

internal-distclean: $$(KIND)
	@rm -rf ./_build/$(KIND)

compile-aes:
	( cd apps/aesophia && make compile_test_aes CONTRACT=$(CONTRACT) ; )

.PHONY: \
	all console \
	local-build local-start local-stop local-attach \
	prod-build prod-start prod-stop prod-attach prod-package prod-compile-deps \
	multi-build multi-start multi-stop multi-clean multi-distclean \
	dev1-start dev1-stop dev1-attach dev1-clean dev1-distclean \
	dev2-start dev2-stop dev2-attach dev2-clean dev2-distclean \
	dev3-start dev3-stop dev3-attach dev3-clean dev3-distclean \
	internal-start internal-stop internal-attach internal-clean internal-compile-deps \
	dialyzer \
	docker docker-clean \
	test smoke-test smoke-test-run system-test aevm-test-deps\
	kill killall \
	clean distclean \
	swagger swagger-docs swagger-check swagger-version-check \
	rebar-lock-check \
	compile-aes\
	python-env python-ws-test python-uats python-single-uat python-release-test \
	REVISION
